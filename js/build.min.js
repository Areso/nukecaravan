var R=R||{};R.strings={START_MESSAGE:"Великое путешествие начинается...",DROPPED_GUNS:"Перегрузка. Сбросили оружия: $1",DROPPED_FOOD:"Перегрузка. Сбросили еды: $1",DEATH_STARVED:"Ваш караван погиб от голода",DEATH_ALL:"Все погибли",SUCCESS_HOME:"Вы вернулись домой!",EVENT_FOOD_POISON:"Пищевое отравление. Погибло:",EVENT_BANDITS_ATTACKS:"Вас атаковали бандиты!",UI_DAY:"День"};var Utils=Utils||{};Utils.Random={},Utils.Random.fromArray=function(t){return t[Math.floor(Math.random()*t.length)]},String.prototype.withArg=function(t){return this.replace("$1",t)};var Caravan=Caravan||{};Caravan.Event={},Caravan.Event.eventTypes=[{type:"STAT-CHANGE",notification:"negative",stat:"crew",value:-3,text:"Пищевое отравление. Погибло: "},{type:"STAT-CHANGE",notification:"negative",stat:"crew",value:-4,text:"Вспышка простуды. Погибло: "},{type:"STAT-CHANGE",notification:"negative",stat:"food",value:-10,text:"Заражение червями. Пропало пищи: "},{type:"STAT-CHANGE",notification:"negative",stat:"food",value:-15,text:"Бродяги напали на воз с едой. Пропало пищи: "},{type:"STAT-CHANGE",notification:"positive",stat:"food",value:20,text:"Следопыты нашли дикие ягоды. Запасы пищи пополнены: "},{type:"STAT-CHANGE",notification:"positive",stat:"food",value:100,text:"Следопыты застрелили оленя. Запасы пищи пополнены: "},{type:"STAT-CHANGE",notification:"negative",stat:"money",value:-50,text:"Карманники украли $"},{type:"STAT-CHANGE",notification:"positive",stat:"money",value:15,text:"У дороги найден мертвый путешественник. На теле найдено монет: "},{type:"STAT-CHANGE",notification:"positive",stat:"money",value:5,text:"Встречные охотники купили у вас товары. Денег добавлено:"},{type:"STAT-CHANGE",notification:"positive",stat:"money",value:5,text:"Вы поймали карманника! Отнято денег: $"},{type:"STAT-CHANGE",notification:"negative",stat:"oxen",value:-1,text:"Вспышка гриппа у волов. Погибло: "},{type:"STAT-CHANGE",notification:"positive",stat:"oxen",value:1,text:"Найден дикий вол. Добавлено волов: "},{type:"SHOP",notification:"neutral",text:"You have found a shop",products:[{item:"food",qty:20,price:50},{item:"oxen",qty:1,price:200},{item:"firepower",qty:2,price:50},{item:"crew",qty:5,price:80}]},{type:"SHOP",notification:"neutral",text:"You have found a shop",products:[{item:"food",qty:30,price:50},{item:"oxen",qty:1,price:200},{item:"firepower",qty:2,price:20},{item:"crew",qty:10,price:80}]},{type:"SHOP",notification:"neutral",text:"Smugglers sell various goods",products:[{item:"food",qty:20,price:60},{item:"oxen",qty:1,price:300},{item:"firepower",qty:2,price:80},{item:"crew",qty:5,price:60}]},{type:"ATTACK",notification:"negative",text:R.strings.EVENT_BANDITS_ATTACKS},{type:"ATTACK",notification:"negative",text:R.strings.EVENT_BANDITS_ATTACKS},{type:"ATTACK",notification:"negative",text:R.strings.EVENT_BANDITS_ATTACKS}],Caravan.Event.generateEvent=function(){var t=Utils.Random.fromArray(this.eventTypes);"STAT-CHANGE"==t.type?this.stateChangeEvent(t):"SHOP"==t.type?(this.game.pauseJourney(),this.ui.notify(t.text,t.notification),this.shopEvent(t)):"ATTACK"==t.type&&(this.game.pauseJourney(),this.ui.notify(t.text,t.notification),this.attackEvent(t))},Caravan.Event.stateChangeEvent=function(t){if(t.value+this.caravan[t.stat]>=0){var a=Math.floor(Math.random()*t.value)+1;this.caravan[t.stat]+=a,this.ui.notify(t.text+Math.abs(a),t.notification)}},Caravan.Event.shopEvent=function(t){for(var a,e,i=Math.ceil(4*Math.random()),n=[],r=0;r<i;r++)a=Math.floor(Math.random()*t.products.length),e=.7+.6*Math.random(),n.push({item:t.products[a].item,qty:t.products[a].qty,price:Math.round(t.products[a].price*e)});this.ui.showShop(n)},Caravan.Event.attackEvent=function(t){var a=Math.round((.7+.6*Math.random())*Caravan.ENEMY_FIREPOWER_AVG),e=Math.round((.7+.6*Math.random())*Caravan.ENEMY_GOLD_AVG);this.ui.showAttack(a,e)},(Caravan=Caravan||{}).Caravan={},Caravan.Caravan.init=function(t){this.day=t.day,this.distance=t.distance,this.crew=t.crew,this.food=t.food,this.oxen=t.oxen,this.money=t.money,this.firepower=t.firepower},Caravan.Caravan.updateWeight=function(){var t=0,a=0;for(this.capacity=this.oxen*Caravan.WEIGHT_PER_OX+this.crew*Caravan.WEIGHT_PER_PERSON,this.weight=this.food*Caravan.FOOD_WEIGHT+this.firepower*Caravan.FIREPOWER_WEIGHT;this.food&&this.capacity<=this.weight;)this.food--,this.weight-=Caravan.FOOD_WEIGHT,t++;for(t&&this.ui.notify(R.strings.DROPPED_FOOD.withArg(t));this.firepower&&this.capacity<=this.weight;)this.firepower--,this.weight-=Caravan.FIREPOWER_WEIGHT,a++;a&&this.ui.notify(R.strings.DROPPED_GUNS.withArg(a))},Caravan.Caravan.updateDistance=function(){var t=this.capacity-this.weight,a=Caravan.SLOW_SPEED+t/this.capacity*Caravan.FULL_SPEED;this.distance+=a},Caravan.Caravan.consumeFood=function(){this.food-=this.crew*Caravan.FOOD_PER_PERSON,this.food<0&&(this.food=0)},(Caravan=Caravan||{}).UI={},Caravan.UI.notify=function(t,a){document.getElementById("updates-area").innerHTML='<div class="update-'+a+'">'+R.strings.UI_DAY+" "+Math.ceil(this.caravan.day)+": "+t+"</div>"+document.getElementById("updates-area").innerHTML},Caravan.UI.refreshStats=function(){document.getElementById("stat-day").innerHTML=Math.ceil(this.caravan.day),document.getElementById("stat-distance").innerHTML=Math.floor(this.caravan.distance),document.getElementById("stat-crew").innerHTML=this.caravan.crew,document.getElementById("stat-oxen").innerHTML=this.caravan.oxen,document.getElementById("stat-food").innerHTML=Math.ceil(this.caravan.food),document.getElementById("stat-money").innerHTML=this.caravan.money,document.getElementById("stat-firepower").innerHTML=this.caravan.firepower,document.getElementById("stat-weight").innerHTML=Math.ceil(this.caravan.weight)+"/"+this.caravan.capacity,document.getElementById("caravan").style.left=380*this.caravan.distance/Caravan.FINAL_DISTANCE+"px"},Caravan.UI.showShop=function(t){var a=document.getElementById("shop");a.classList.remove("hidden"),this.shopInitiated||(a.addEventListener("click",function(t){var e=t.target||t.src;"BUTTON"==e.tagName?(a.classList.add("hidden"),Caravan.UI.game.resumeJourney()):"DIV"==e.tagName&&e.className.match(/product/)&&Caravan.UI.buyProduct({item:e.getAttribute("data-item"),qty:e.getAttribute("data-qty"),price:e.getAttribute("data-price")})}),this.shopInitiated=!0);var e=document.getElementById("prods");e.innerHTML="";for(var i,n=0;n<t.length;n++)i=t[n],e.innerHTML+='<div class="product" data-qty="'+i.qty+'" data-item="'+i.item+'" data-price="'+i.price+'">'+i.qty+" "+i.item+" - $"+i.price+"</div>"},Caravan.UI.buyProduct=function(t){if(t.price>Caravan.UI.caravan.money)return Caravan.UI.notify("Not enough money","negative"),!1;Caravan.UI.caravan.money-=t.price,Caravan.UI.caravan[t.item]+=+t.qty,Caravan.UI.notify("Bought "+t.qty+" x "+t.item,"positive"),Caravan.UI.caravan.updateWeight(),Caravan.UI.refreshStats()},Caravan.UI.showAttack=function(t,a){document.getElementById("attack").classList.remove("hidden"),this.firepower=t,this.gold=a,document.getElementById("attack-description").innerHTML="Firepower: "+t,this.attackInitiated||(document.getElementById("fight").addEventListener("click",this.fight.bind(this)),document.getElementById("runaway").addEventListener("click",this.runaway.bind(this)),this.attackInitiated=!0)},Caravan.UI.fight=function(){var t=this.firepower,a=this.gold,e=Math.ceil(Math.max(0,2*t*Math.random()-this.caravan.firepower));e<this.caravan.crew?(this.caravan.crew-=e,this.caravan.money+=a,this.notify(e+" people were killed fighting","negative"),this.notify("Found $"+a,"gold")):(this.caravan.crew=0,this.notify("Everybody died in the fight","negative")),document.getElementById("attack").classList.add("hidden"),this.game.resumeJourney()},Caravan.UI.runaway=function(){var t=this.firepower,a=Math.ceil(Math.max(0,t*Math.random()/2));a<this.caravan.crew?(this.caravan.crew-=a,this.notify(a+" people were killed running","negative")):(this.caravan.crew=0,this.notify("Everybody died running away","negative")),document.getElementById("runaway").removeEventListener("click"),document.getElementById("attack").classList.add("hidden"),this.game.resumeJourney()},(Caravan=Caravan||{}).WEIGHT_PER_OX=20,Caravan.WEIGHT_PER_PERSON=2,Caravan.FOOD_WEIGHT=.6,Caravan.FIREPOWER_WEIGHT=5,Caravan.GAME_SPEED=800,Caravan.DAY_PER_STEP=.2,Caravan.FOOD_PER_PERSON=.02,Caravan.FULL_SPEED=5,Caravan.SLOW_SPEED=3,Caravan.FINAL_DISTANCE=1e3,Caravan.EVENT_PROBABILITY=.15,Caravan.ENEMY_FIREPOWER_AVG=5,Caravan.ENEMY_GOLD_AVG=50,Caravan.Game={},Caravan.Game.init=function(){this.ui=Caravan.UI,this.eventManager=Caravan.Event,this.caravan=Caravan.Caravan,this.caravan.init({day:0,distance:0,crew:30,food:80,oxen:2,money:300,firepower:2}),this.caravan.ui=this.ui,this.caravan.eventManager=this.eventManager,this.ui.game=this,this.ui.caravan=this.caravan,this.ui.eventManager=this.eventManager,this.eventManager.game=this,this.eventManager.caravan=this.caravan,this.eventManager.ui=this.ui,this.startJourney()},Caravan.Game.startJourney=function(){this.gameActive=!0,this.previousTime=null,this.ui.notify(R.strings.START_MESSAGE,"positive"),this.step()},Caravan.Game.step=function(t){this.previousTime||(this.previousTime=t,this.updateGame()),t-this.previousTime>=Caravan.GAME_SPEED&&(this.previousTime=t,this.updateGame()),this.gameActive&&window.requestAnimationFrame(this.step.bind(this))},Caravan.Game.updateGame=function(){return this.caravan.day+=Caravan.DAY_PER_STEP,this.caravan.consumeFood(),0===this.caravan.food?(this.ui.notify(R.strings.DEATH_STARVED,"negative"),void(this.gameActive=!1)):(this.caravan.updateWeight(),this.caravan.updateDistance(),this.ui.refreshStats(),this.caravan.crew<=0?(this.caravan.crew=0,this.ui.notify(R.strings.DEATH_ALL,"negative"),void(this.gameActive=!1)):this.caravan.distance>=Caravan.FINAL_DISTANCE?(this.ui.notify(R.strings.SUCCESS_HOME,"positive"),void(this.gameActive=!1)):void(Math.random()<=Caravan.EVENT_PROBABILITY&&this.eventManager.generateEvent()))},Caravan.Game.pauseJourney=function(){this.gameActive=!1},Caravan.Game.resumeJourney=function(){this.gameActive=!0,this.step()},Caravan.Game.init();