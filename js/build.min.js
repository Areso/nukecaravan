function Observable(a){this.data=a,this.subscribers=[];}function addLogMessage(a,b,c){a.log.push({day:a.day,message:c,goodness:b});}function WorldState(a){this.day=a.day,this.distance=a.distance,this.crew=a.crew,this.food=a.food,this.oxen=a.oxen,this.money=a.money,this.firepower=a.firepower,this.log=[],this.from={x:0},this.to={x:1000},this.dead=!1,this.paused=!1,this.capacity=0,this.weight=0;}function DeathCheck(){this.rules=DeathRules;}function WeightCheck(){}function UI(){this.logLength=0;}function initActionUi(a,b){var c=document.getElementById('actions-dropweapon');var d=document.getElementById('actions-dropfood');d.addEventListener('click',function(c){console.log('dropFoodButton clicked!'),a.food--,a.weight-=Caravan.FOOD_WEIGHT,addLogMessage(a,Goodness.neutral,R.strings.DROPPED_FOOD.withArg(Caravan.FOOD_WEIGHT)),b.onWorldUpdate(),a.paused&&b.resume();}),c.addEventListener('click',function(c){console.log('dropWeaponButton clicked!'),a.firepower--,a.weight-=Caravan.FIREPOWER_WEIGHT,addLogMessage(a,Goodness.neutral,R.strings.DROPPED_GUNS.withArg(Caravan.FIREPOWER_WEIGHT)),b.onWorldUpdate(),a.paused&&b.resume();});}function TimePlugin(a){this.game=a;}function DistancePlugin(a){this.game=a,this.rules=DistanceRules,this.rules.forEach(function(a){a.notVisited=!0;});}function RandomEventPlugin(a){this.game=a,this.events=RandomEvents;}function ShopPlugin(a){this.game=a,this.isListenerAdded=!1,this.products=[],this.previousShop={x:0},this.shops=ShopEvents;}function Game(){this.plugins=[new TimePlugin(this),new DistancePlugin(this),new RandomEventPlugin(this),new ShopPlugin(this)],this.world=new WorldState({day:0,distance:0,crew:30,food:80,oxen:2,money:300,firepower:2}),this.worldObservable=new Observable(this.world),this.deathCheck=new DeathCheck(),this.worldObservable.subscribe(this.deathCheck),this.worldObservable.subscribe(new WeightCheck()),this.ui=new UI(),this.worldObservable.subscribe(this.ui),this.onWorldUpdate(),initActionUi(this.world,this);}var R=R||{};R.strings={START_MESSAGE:'Великое путешествие начинается...',DROPPED_GUNS:'Перегрузка. Сбросили оружия: $1',DROPPED_FOOD:'Перегрузка. Сбросили еды: $1',DEATH_STARVED:'Ваш караван погиб от голода',DEATH_ALL:'Все погибли',SUCCESS_HOME:'Вы вернулись домой!',EVENT_FOOD_POISON:'Пищевое отравление. Погибло:',EVENT_BANDITS_ATTACKS:'Вас атаковали бандиты!',EVENT_SHOP_FOUND:'Вы нашли магазин',BATTLE_FIGHT:'В бою погибло ваших людей: $1',BATTLE_LOOT:'С павших бандитов поднято золота: $1',BATTLE_FIGHT_DEATH_ALL:'В бою погибли все!',BATTLE_RUN:'При бегстве погибло ваших людей: $1',BATTLE_RUN_DEATH_ALL:'Пытаясь бежать, погибли все!',SHOP_MONEY_NOT_ENOUGH:'Не хватает денег',UI_DAY:'День',UI_FIREPOWER:'Оружие'};var Utils=Utils||{};Utils.Random={},Utils.Random.fromArray=function(a){return a[Math.floor(Math.random()*a.length)];},String.prototype.withArg=function(a){return this.replace('$1',a);},Array.prototype.getRandom=function(){return this[Math.floor(Math.random()*this.length)];},Observable.prototype.subscribe=function(a){this.subscribers.push(a);},Observable.prototype.update=function(){var a;var b=this.subscribers.length;for(a=0;a<b;a++)this.subscribers[a].update(this.data);};var Goodness={positive:'positive',negative:'negative',neutral:'neutral'};var DistanceRules=[{distance:100,text:'Ваш караван прибыл в город!',title:'Прибытие',pause:!0},{distance:50,text:'Половина пути пройдена!',title:'На половине пути',pause:!1}];var DeathRules=[{param:'food',death:0,live:1,text:'Ваш караван погиб от голода'},{param:'crew',death:0,live:1,text:'В караване не осталось живых людей'}];var RandomEvents=[{goodness:Goodness.negative,stat:'crew',value:-3,text:'Пищевое отравление. Погибло: $1'},{goodness:Goodness.negative,stat:'crew',value:-4,text:'Вспышка простуды. Погибло: $1'},{goodness:Goodness.negative,stat:'food',value:-10,text:'Заражение червями. Пропало пищи: $1'},{goodness:Goodness.negative,stat:'food',value:-15,text:'Бродяги напали на воз с едой. Пропало пищи: $1'},{goodness:Goodness.positive,stat:'food',value:20,text:'Следопыты нашли дикие ягоды. Запасы пищи пополнены: $1'},{goodness:Goodness.positive,stat:'food',value:100,text:'Следопыты застрелили оленя. Запасы пищи пополнены: $1'},{goodness:Goodness.negative,stat:'money',value:-50,text:'Карманники украли $$1'},{goodness:Goodness.positive,stat:'money',value:15,text:'У дороги найден мертвый путешественник. На теле найдено монет: $1'},{goodness:Goodness.positive,stat:'money',value:5,text:'Встречные охотники купили у вас товары. Денег добавлено: $$1'},{goodness:Goodness.positive,stat:'money',value:5,text:'Вы поймали карманника! Отнято денег: $$1'},{goodness:Goodness.negative,stat:'oxen',value:-1,text:'Вспышка гриппа у волов. Погибло: $1'},{goodness:Goodness.positive,stat:'oxen',value:1,text:'Найден дикий вол. Добавлено волов: $1'}];var ShopEvents=[{text:'Вы нашли магазин в этой жуткой пустоши',products:[{item:'food',qty:20,price:50},{item:'oxen',qty:1,price:200},{item:'firepower',qty:2,price:50},{item:'crew',qty:5,price:80}]},{text:'Вы встретили другой караван!',products:[{item:'food',qty:30,price:50},{item:'oxen',qty:1,price:200},{item:'firepower',qty:2,price:20},{item:'crew',qty:10,price:80}]},{text:'Следопыты встретили контрабандистов',products:[{item:'food',qty:20,price:60},{item:'oxen',qty:1,price:300},{item:'firepower',qty:2,price:80},{item:'crew',qty:5,price:60}]}];var ShopConstants={SHOP_INTERVAL_MIN:100,SHOP_PROBABILITY:0.15,SHOP_NO_MONEY_MESSAGE:'Не хватает денег!',SHOP_BUY_MESSAGE:'Вы купили'};DeathCheck.prototype.update=function(c){var b,a,d,f=this.game,e=!1;for(b=0;b<this.rules.length;b++)if(a=this.rules[b],d=(a.live-a.death)/Math.abs(a.live-a.death),c[a.param]==a.death||c[a.param]*d<a.death){this.onDeath(c,a);break;}return e;},DeathCheck.prototype.onDeath=function(a,b){addLogMessage(a,Goodness.negative,b.text),a.dead=!0,a.paused=!0;},WeightCheck.prototype.update=function(a){a.capacity=a.oxen*Caravan.WEIGHT_PER_OX+a.crew*Caravan.WEIGHT_PER_PERSON,a.weight=a.food*Caravan.FOOD_WEIGHT+a.firepower*Caravan.FIREPOWER_WEIGHT;},UI.prototype.notify=function(a,b){var a='<div class="update-'+b+'">'+R.strings.UI_DAY+' '+Math.ceil(this.caravan.day)+': '+a+'</div>';this.addInnerHtml('updates-area',a);},UI.prototype.addInnerHtml=function(b,c){var a=document.getElementById(b);a.innerHTML=c+a.innerHTML;},UI.prototype.show=function(a,b){document.getElementById(a).innerHTML=''+b;},UI.prototype.update=function(a){this.show('stat-day',Math.ceil(a.day)),this.show('stat-distance',Math.floor(a.distance)),this.show('stat-crew',a.crew),this.show('stat-oxen',a.oxen),this.show('stat-food',Math.ceil(a.food)),this.show('stat-money',a.money),this.show('stat-firepower',a.firepower),this.show('stat-weight',Math.ceil(a.weight)+'/'+a.capacity);var b=364*(a.distance/a.to.x)+'px';document.getElementById('caravan').style.left=b,console.log('worldState.distance = '+a.distance),console.log('caravanPosition = '+b),this.refreshLog(a.log);},UI.prototype.refreshLog=function(a){if(this.logLength==a.length)return;var c='',b;for(b=a.length-1;b>=0;b--)c+=this.formatMessage(a[b]);this.show('updates-area',c),console.log('log refreshes, log size: '+a.length),this.logLength=a.length;},UI.prototype.formatMessage=function(a){var b=this.getMessageClass(a);var c='<div class="'+b+'">'+R.strings.UI_DAY+' '+Math.ceil(a.day)+': '+a.message+'</div>';return c;},UI.prototype.getMessageClass=function(b){var a='update-';return a+b.goodness;},UI.prototype.showAttack=function(a,c){var b=document.getElementById('attack');b.classList.remove('hidden'),this.firepower=a,this.gold=c,document.getElementById('attack-description').innerHTML=R.strings.UI_FIREPOWER+': '+a,this.attackInitiated||(document.getElementById('fight').addEventListener('click',this.fight.bind(this)),document.getElementById('runaway').addEventListener('click',this.runaway.bind(this)),this.attackInitiated=!0);},UI.prototype.fight=function(){var c=this.firepower;var b=this.gold;var a=Math.ceil(Math.max(0,c*2*Math.random()-this.caravan.firepower));a<this.caravan.crew?(this.caravan.crew-=a,this.caravan.money+=b,this.notify(R.strings.BATTLE_FIGHT.withArg(a),'negative'),this.notify(R.strings.BATTLE_LOOT.withArg(b),'gold')):(this.caravan.crew=0,this.notify(R.strings.BATTLE_FIGHT_DEATH_ALL,'negative')),document.getElementById('attack').classList.add('hidden'),this.game.resume();},UI.prototype.runaway=function(){var b=this.firepower;var a=Math.ceil(Math.max(0,b*Math.random()/2));a<this.caravan.crew?(this.caravan.crew-=a,this.notify(R.strings.BATTLE_RUN.withArg(a),'negative')):(this.caravan.crew=0,this.notify(R.strings.BATTLE_RUN_DEATH_ALL,'negative')),document.getElementById('runaway').removeEventListener('click',Caravan.UI.runaway),document.getElementById('attack').classList.add('hidden'),this.game.resume();},TimePlugin.prototype.run=function(a){a.day===0&&addLogMessage(a,Goodness.positive,R.strings.START_MESSAGE),a.day+=Caravan.DAY_PER_STEP,this.consumeFood(a),a.food>0&&this.updateDistance(a);},TimePlugin.prototype.consumeFood=function(a){a.food-=a.crew*Caravan.FOOD_PER_PERSON,a.food<0&&(a.food=0);},TimePlugin.prototype.updateDistance=function(a){var b=a.weight-a.capacity;if(b>0){addLogMessage(a,Goodness.negative,'Караван перегружен и не может двигаться'),a.paused=!0;return;}var c=Caravan.SLOW_SPEED-b/a.capacity*Caravan.FULL_SPEED;a.distance+=c;},DistancePlugin.prototype.run=function(c){var d=100*c.distance/c.to.x;var b,a,e=this.game;for(b=0;b<this.rules.length;b++)if(a=this.rules[b],d>=a.distance&&a.notVisited){a.notVisited=!1,addLogMessage(c,Goodness.positive,a.text),a.pause&&e.pause();break;}},RandomEventPlugin.prototype.run=function(c){if(console.log('RandomEventPlugin run'),Math.random()>Caravan.EVENT_PROBABILITY)return;var b=this.events.getRandom();var a=b.value;if(a=Math.floor(Math.random()*a),a==0)return;a<0&&Math.abs(a)>c[b.stat]&&(a=Math.floor(c[b.stat])),c[b.stat]+=a;var d=b.text.withArg(a);addLogMessage(c,b.goodness,d);},ShopPlugin.prototype.run=function(a){if(a.distance<100||a.distance>900)return;var b=a.distance-this.previousShop.x;if(ShopConstants.SHOP_INTERVAL_MIN>b)return;if(Math.random()>ShopConstants.SHOP_PROBABILITY)return;var c=this.shops.getRandom();this.products=this.generateProducts(c),this.game.pause(),this.show(this.products);},ShopPlugin.prototype.show=function(e){console.log('ShopPlugin show');var c=document.getElementById('shop');c.classList.remove('hidden'),this.isListenerAdded||(this.addListeners(c),this.isListenerAdded=!0);var d=document.getElementById('prods');d.innerHTML='';var b;for(var a=0;a<e.length;a++)b=e[a],d.innerHTML+='<div class="product" data-index="'+a+'">'+b.qty+' '+b.item+' - $'+b.price+'</div>';},ShopPlugin.prototype.addListeners=function(b){var a=this;b.addEventListener('click',function(e){var c=e.target||e.src;if(c.tagName=='BUTTON')b.classList.add('hidden'),a.game.resume();else if(c.tagName=='DIV'&&c.className.match(/product/)){var d=a.products[c.getAttribute('data-index')];a.buy(d.item,d.qty,d.price);}});},ShopPlugin.prototype.generateProducts=function(a){var e=4;var f=Math.ceil(Math.random()*e);var c=[];var b,g;for(var d=0;d<f;d++)b=Math.floor(Math.random()*a.products.length),g=0.7+0.6*Math.random(),c.push({item:a.products[b].item,qty:a.products[b].qty,price:Math.round(a.products[b].price*g)});return c;},ShopPlugin.prototype.buy=function(b,c,d){var a=this.game.world;if(d>a.money)return addLogMessage(a,Goodness.negative,ShopConstants.SHOP_NO_MONEY_MESSAGE),this.game.onWorldUpdate(),!1;a.money-=d,a[b]+=+c,addLogMessage(a,Goodness.positive,ShopConstants.SHOP_BUY_MESSAGE+' '+c+' x '+b),this.game.onWorldUpdate();};var Caravan=Caravan||{};Caravan.WEIGHT_PER_OX=20,Caravan.WEIGHT_PER_PERSON=2,Caravan.FOOD_WEIGHT=0.6,Caravan.FIREPOWER_WEIGHT=5,Caravan.GAME_SPEED=800,Caravan.DAY_PER_STEP=0.2,Caravan.FOOD_PER_PERSON=0.02,Caravan.FULL_SPEED=50,Caravan.SLOW_SPEED=39,Caravan.EVENT_PROBABILITY=0.15,Caravan.ENEMY_FIREPOWER_AVG=5,Caravan.ENEMY_GOLD_AVG=50,Game.prototype.onWorldUpdate=function(){this.worldObservable.update();},Game.prototype.resume=function(){console.log('Game is resumed'),this.world.paused=!1,this.time=0,this.previousTime=0,this.interval=setInterval(this.step,Caravan.GAME_SPEED,this);},Game.prototype.pause=function(){console.log('Game is paused'),this.world.paused=!0;},Game.prototype.step=function(a){a.time+=Caravan.GAME_SPEED;var b=a.time-a.previousTime;if(a.previousTime=a.time,b>=Caravan.GAME_SPEED)for(index=0;index<a.plugins.length;index++)if(a.plugins[index].run(a.world),a.world.paused)break;a.onWorldUpdate(),a.world.paused&&clearInterval(a.interval),console.log('Game.step!'),console.log('game.previousTime :'+a.previousTime),console.log('game.time :'+a.time);};var newGame=new Game();newGame.resume();